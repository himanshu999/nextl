<!DOCTYPE html>
<html lang="en">
	<head>
		<title>NextL Viewer</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300&display=swap" rel="stylesheet">
		<link type="text/css" rel="stylesheet" href="./assets/main.css">
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.7.0/gsap.min.js"></script>
		
		<style>
			body {
				color: #000;
				overflow-x:hidden;
				overflow-y:hidden;
				font-family: 'Nunito', sans-serif;
				background: transparent;
			}

			a {
				color: #f00;
			}

		

			
		</style>
		<script>
		 var camerag, selectedPart;
		</script>
	</head>

	<body>
		
		

		<script type="module">

			import * as THREE from './build/three.module.js';

			import { GLTFLoader } from './jsm/GLTFLoader.js';

			import { OrbitControls } from './jsm/OrbitControls.js';

			import { RoomEnvironment } from './jsm/RoomEnvironment.js';

			let camera, controls, scene, renderer, pmremGenerator;
			
			let raycaster, mouse = {};
			let model, selectedPart;
		
			let textureLoader, materialLoader;

			let materials = [];

			init();
			
			animate();

			function init() {

				scene = new THREE.Scene();
				//scene.background = new THREE.Color( 0xcccccc );
				scene.background = null;
				

				renderer = new THREE.WebGLRenderer( { antialias: true, alpha: true } );
				renderer.outputEncoding = THREE.sRGBEncoding;
				renderer.toneMapping = THREE.ACESFilmicToneMapping;
				renderer.exposure = 1.0;
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.body.appendChild( renderer.domElement );


				pmremGenerator = new THREE.PMREMGenerator( renderer );
				

				scene.environment = pmremGenerator.fromScene( new RoomEnvironment(), 0.04 ).texture;


				camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 1000 );
				camera.position.set( 400, 200, 0 );
				camerag = camera;

				// controls

				controls = new OrbitControls( camera, renderer.domElement );
				controls.listenToKeyEvents( window ); // optional

				
				controls.enableDamping = true; 
				controls.dampingFactor = 0.05;

				controls.screenSpacePanning = false;

				controls.minDistance = 100;
				controls.maxDistance = 500;

				const shoeLaceMaterial = new THREE.MeshStandardMaterial({ color: 0x444444, roughness: 0.8, metalness: 0.1 });
				

				//controls.maxPolarAngle = Math.PI / 2;


				materialLoader = new THREE.MaterialLoader();
				
				const loader = new GLTFLoader();
				
				loader.load( './assets/shoe.glb', function ( gltf ) {

							gltf.scene.traverse( function ( child ) {
								
								
								if ( child.isMesh ) {

									//roughnessMipmapper.generateMipmaps( child.material );
									child.material = new THREE.MeshStandardMaterial({ color: 0x445566, roughness: 0.9, metalness: 0.1   });
									child.material.color.r = Math.random(100);
									child.material.color.g = Math.random(100);
									child.material.color.b = Math.random(100);

									if(child.name.startsWith('pasted__pPlane')) child.material = shoeLaceMaterial;
									
									child.material.needsUpdate = true;
									console.log(child.name);

									
									

								}

							} ); 
							
							gltf.scene.scale.set(40,40,40);
							//gltf.scene.position.set(0,-30,0);

							
							model = gltf.scene;
							scene.add( model );

							
							

						} );


				textureLoader = new THREE.TextureLoader();
				//createMaterials();
				

				raycaster = new THREE.Raycaster();
				

				window.addEventListener( 'resize', onWindowResize );
				window.addEventListener('pointerdown', raycast);
	
				window.model = model;

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				//adjustedCanvasWidth = renderer.domElement.width / window.devicePixelRatio;
				//adjustedCanvasHeight = renderer.domElement.height / window.devicePixelRatio;

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {

				requestAnimationFrame( animate );

				controls.update(); 

				

				render();

			}

			function render() {

				renderer.render( scene, camera );

			}

		


			function raycast(event){ 

				mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
				mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

				raycaster.setFromCamera( mouse, camera );

			
				const intersects = raycaster.intersectObjects( scene.children, true );

				

				if(intersects.length > 0) {
					
					/*const prevColor = intersects[0].object.material.color.clone();

					intersects[0].object.material.color.set(0x6200ee);

					setTimeout( () => { 
					
						intersects[0].object.material.color.set(prevColor);

					}, 500);*/

					selectedPart = intersects[0].object; 

					//selectedPart.material.copy(materials[Math.floor(Math.random() * (3))]);

					//selectedPart.material.needsUpdate = true;

				}
			}

		
			function createMaterials() { 
				
				let testMaterial = new THREE.MeshStandardMaterial({ roughness: 0.5, metalness: 0.2});

				let texture = textureLoader.load('./assets/leather2.jpg');

				texture.wrapS = THREE.RepeatWrapping;
				texture.wrapT = THREE.RepeatWrapping;
				texture.repeat.set( 20, 20 );


				let normalTexture = textureLoader.load('./assets/leather2_normal.jpg');

				normalTexture.wrapS = THREE.RepeatWrapping;
				normalTexture.wrapT = THREE.RepeatWrapping;
				normalTexture.repeat.set( 20, 20 );

				let aoTexture = textureLoader.load('./assets/leather2.jpg');

				aoTexture.wrapS = THREE.RepeatWrapping;
				aoTexture.wrapT = THREE.RepeatWrapping;
				aoTexture.repeat.set( 20, 20 ); 


				testMaterial.map = texture;
				//testMaterial.normalMap = normalTexture;
				testMaterial.normalScale = new THREE.Vector2(0.001, 0.001);
				testMaterial.aoMap = aoTexture;
				testMaterial.aoMapIntensity = 0.6;
				
			
				materials.push(testMaterial);


				texture = textureLoader.load('./assets/leather.jpg');

				texture.wrapS = THREE.RepeatWrapping;
				texture.wrapT = THREE.RepeatWrapping;
				texture.repeat.set( 18, 18 );


				normalTexture = textureLoader.load('./assets/leather_normal.jpg');

				normalTexture.wrapS = THREE.RepeatWrapping;
				normalTexture.wrapT = THREE.RepeatWrapping;
				normalTexture.repeat.set( 18, 18 );

				aoTexture = textureLoader.load('./assets/leather_ao.jpg');

				aoTexture.wrapS = THREE.RepeatWrapping;
				aoTexture.wrapT = THREE.RepeatWrapping;
				aoTexture.repeat.set( 18, 18 ); 


				testMaterial = new THREE.MeshStandardMaterial({color: 0xeeeeee, roughness: 0.5, metalness: 0.2});
				testMaterial.map = texture;
				testMaterial.normalMap = normalTexture;
				testMaterial.normalScale = new THREE.Vector2(0.8, 0.8);
				testMaterial.aoMap = aoTexture;
				testMaterial.aoMapIntensity = 1.0;
				
				materials.push(testMaterial);


				texture = textureLoader.load('./assets/leather3.jpg');

				texture.wrapS = THREE.RepeatWrapping;
				texture.wrapT = THREE.RepeatWrapping;
				texture.repeat.set( 14, 14 );


				normalTexture = textureLoader.load('./assets/leather3_normal.jpg');

				normalTexture.wrapS = THREE.RepeatWrapping;
				normalTexture.wrapT = THREE.RepeatWrapping;
				normalTexture.repeat.set( 14, 14 );

				aoTexture = textureLoader.load('./assets/leather3_ao.jpg');

				aoTexture.wrapS = THREE.RepeatWrapping;
				aoTexture.wrapT = THREE.RepeatWrapping;
				aoTexture.repeat.set( 14, 14 ); 


				testMaterial = new THREE.MeshStandardMaterial({roughness: 0.5, metalness: 0.2});
				testMaterial.map = texture;
				testMaterial.normalMap = normalTexture;
				testMaterial.normalScale = new THREE.Vector2(0.8, 0.8);
				testMaterial.aoMap = aoTexture;
				testMaterial.aoMapIntensity = 1.0;
				
				materials.push(testMaterial);

				

				console.log(materials);
				
				setTimeout(() => {
	
					const materialJSON = JSON.stringify(materials[2].toJSON());
					
					const mat = {
					name: 'Test 03',
					category: 'Leather',
					materialJSON,
					};
		
					parent.window.saveMaterial(mat);
				}, 1000); 

				
				
			
			}
		

			const changeMaterial = (mat) => { 
					
				
				const material = materials.find((matrl) => (matrl.uuid === mat.uuid));
				
				selectedPart.material.copy(material);
				
				selectedPart.material.needsUpdate = true;
				
			}

			const loadMaterials = () => {

				materials = [];
				
				
				window.parent.appData.materials.forEach((mat) => {
				
				   mat = JSON.parse(mat.materialJSON);
		                   let loadedTextures = {};	
				   
				   if(mat.textures)		
				   mat.textures.forEach((tex) => { 
					console.log(tex);	
					const image = mat.images.find( (img) => (img.uuid === tex.image) );
										
					let texture = textureLoader.load(image.url);
					texture.format = tex.format;
					texture.wrapS = tex.wrap[0];
					texture.wrapT = tex.wrap[1];
					texture.repeat.x = tex.repeat[0];
					texture.repeat.y = tex.repeat[1];		
					
					loadedTextures[tex.uuid] = texture;

				});

				materialLoader.setTextures(loadedTextures);
				
				let material = materialLoader.parse(mat);
				material.uuid = mat.uuid;
				console.log(mat);
				console.log(material);
				materials.push(material);	

				});


				console.log(materials);

				
			}

			window.changeMaterial = changeMaterial;

			window.loadMaterials = loadMaterials;			
			

		</script>

	</body>
</html>

